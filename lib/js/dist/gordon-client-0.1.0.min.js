/* Gordon JS Client 0.1.0 23-04-2014 */
this.gordon=this.gordon||{},this.gordon.message={JOIN:0,JOIN_ERROR:1,NEW_USER:2,CHANGE_ROOM:3,CHANGE_ROOM_ERROR:4,USER_CHANGED_ROOM:5,MASTER:6,USER_LEFT:7,DATA_OBJECT_UPDATE:8,DATA_OBJECT_DELETE:9,DATA_OBJECT_CREATED:10,INIT_DATA_OBJECT:18,GET_SESSION_LIST:11,GET_ROOM_LIST:12,GET_USER_LIST:13,CHAT_MESSAGE:14,CUSTOM_MESSAGE:15,PING:16},this.gordon=this.gordon||{},this.gordon._eventId=0,function(){"use strict";function a(){this._listeners={},this.id=Math.random()+" "+gordon._eventId++}var b=a.prototype;b.superconstructor=a,b.on=function(a,b){var c=this._listeners[a];if(c){if(-1!=c.indexOf(b))return}else c=this._listeners[a]=[];return c.push(b),this},b.addEventListener=b.on,b.removeListener=function(a,b){var c=this._listeners[a];if(c){var d=c.indexOf(b);if(-1!=d)return c.splice(d,1),this}},b.once=function(a,b){function c(){this.removeListener(a,c),b.apply(this,arguments)}return c.listener=b,this.on(a,c),this},b.removeAllListeners=function(a){return null!=this._listeners[a]?(this._listeners[a]=null,delete this._listeners[a],this):void 0},b.listeners=function(a){var b=this._listeners[a];return b?b.slice():0},b.listenerCount=function(a){var b=this._listeners[a];return b?b.length():0},b.emit=function(a){var b=this._listeners[a];if(b){for(var c=arguments.length,d=new Array(c-1),e=1;c>e;e++)d[e-1]=arguments[e];var f=b.slice();for(c=f.length,e=0;c>e;e++)f[e].apply(this,d);return this}},b.dispose=function(){return this._listeners=null,this},a.CONNECTED="connected",a.CLOSED="closed",a.JOINED="joined",a.NEW_USER="newUser",a.USER_LEFT="userLeft",a.ROOM_CHANGED="roomChanged",a.PING="ping",a.CUSTOM_MESSAGE="customMessage",a.CHAT_MESSAGE="chatMessage",a.PRIVATE_CHAT_MESSAGE="privateChatMessage",a.NEW_DATA_OBJECT="newDataObject",a.DATA_OBJECT_REMOVED="dataObjectRemoved",a.DATA_OBJECT_UPDATE="dataObjectUpdate",a.MASTER="master",gordon.Event=a}(),this.gordon=this.gordon||{},this.gordon.Util={toUtf8Buffer:function(a){for(var b=[],c=a.length,d=0;c>d;++d){var e=a.charCodeAt(d);b[d]=e}return b},bufferToUtf8String:function(a,b,c){return b=b||0,c=c||a.length,decodeURIComponent(encodeURIComponent(String.fromCharCode.apply(null,new Uint8Array(a,b,c))))},utf8StringToBuffer:function(a,b,c){for(var d=decodeURIComponent(encodeURIComponent(a)),e=new Uint8Array(b,c,d.length),f=0;f<d.length;f++)e[f]=d.charCodeAt(f);return e},writeArrayToBuffer:function(a,b,c){for(var d=c.length,e=0;d>e;++e)a.setUint8(b+e,c[e])},copyBytes:function(a,b,c,d,e){var f=new Uint8Array(a),g=new Uint8Array(b,d||0,e||b.length);f.set(g,c||0)},hexDump:function(a,b,c){"use strict";var d=gordon.Util._fillUp,e=new DataView(a);b=b||0,c=c||a.byteLength;for(var f=d("Offset",8," ")+"  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F\n",g="",h=0;c>h;h+=16){g+=d(b.toString(16).toUpperCase(),8,"0")+"  ";for(var i=Math.min(16,c-b),j="",k=0;16>k;++k)if(i>k){var l=e.getUint8(b);j+=l>=32?String.fromCharCode(l):".",g+=d(l.toString(16).toUpperCase(),2,"0")+" ",b++}else g+="   ",j+=" ";g+=" "+j+"\n"}return f+=g},_fillUp:function(a,b,c){for(var d=b-a.length,e="";--d>-1;)e+=c;return e+a},extend:function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a,a.superclass=b.prototype,b.prototype.constructor==Object.prototype.constructor&&(b.prototype.constructor=b)}},function(){"use strict";var a=function(a){if(this._values={},this.length=0,a)for(var b in a)this._values[b]=a[b]},b=a.prototype;b.put=function(a,b){return this._values[a]||this.length++,this._values[a]=b,b},b.get=function(a){return this._values[a]},b.remove=function(a,b){this._values[a]||this.length--;var c=this._values[a];return b&&"dispose"in c&&c.dispose(),this._values[a]=null,delete this._values[a],c},b.dispose=function(a){for(var b in this._values)this.remove(b,a);this.length=0},b.hasKey=function(a){return null!==this._values[a]},b.keysToArray=function(){var a=[];for(var b in this._values)a.push(b);return a},b.valuesToArray=function(){var a=[];for(var b in this._values)a.push(this._values[b]);return a},b.clone=function(){var a=new gordon.Dictionary;for(var b in this._values)a.put(b,this._values[b]);return a},gordon.Dictionary=a}(),function(){"use strict";function a(a,b){b=b||!0,this.tickAmount=a||33.33333,this.time=0,this._callbacks=[],this._lastTime=this._startTime=Date.now(),b&&this.start()}a.prototype.stop=function(){clearTimeout(this.timeout)},a.prototype.start=function(a){this.tickAmount=a||this.tickAmount,this.timeout=setTimeout(this._loop.bind(this),this.tickAmount)},a.prototype._loop=function(){var a=Date.now(),b=(a-this._lastTime)/this.tickAmount;this.time+=this.tickAmount;for(var c=this._callbacks,d=c.length,e=0;d>e;++e){var f=c[e];f.loop&&f.loop.apply(f,[b,this.time])}this._lastTime=a;var g=a-this._startTime-this.time;this.timeout=setTimeout(this._loop.bind(this),this.tickAmount-g)},a.prototype.addObject=function(a){this._callbacks.push(a)},a.prototype.removeObject=function(a){var b=this._callbacks.indexOf(a);-1!=b&&this._callbacks.splice(b,1)},a.prototype.dispose=function(){this._callbacks=null},gordon.Timer=a}(),ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(a,b){var c=new Uint8Array(this);void 0===b&&(b=c.length);for(var d=new ArrayBuffer(b-a),e=new Uint8Array(d),f=0;f<e.length;f++)e[f]=c[f+a];return d}),this.gordon=this.gordon||{},function(){"use strict";var a=function(a){this.id=a,this._users=new gordon.Dictionary,this._dataObjects=new gordon.Dictionary,this.data={},this.master=null},b=a.prototype;b.getUser=function(a){return this._users.get(a)},b.getUsers=function(){return this._users.valuesToArray()},b.addDataObject=function(a,b,c){var d=this._main._structure.initDataObject(a,c);this._main._protocol.out_initDataObject(a,b,d)},b.getDataObject=function(a){return this._dataObjects.get(a)},b.getDataObjects=function(){return this._dataObjects.valuesToArray()},b.getUserCount=function(){return this._users.length},b.__addUser=function(a){return this._users.put(a.id,a),a},b.__removeUser=function(a){return this._users.remove(a)},b.__dispose=function(){this._users.dispose(),this._dataObjects.dispose(),this.id=-1,this._users=null,this._dataObjects=null,this.data=null},gordon.Room=a}(),this.gordon=this.gordon||{},function(){"use strict";function a(){this.id=-1,this.master=!1,this.superconstructor()}var b=a.prototype=new gordon.Event;b.__dispose=function(){this.dataObject&&this.dataObject.dispose(),this.room=null,this.id=-1},a.DISPOSE="dispose",a.CHAT_MESSAGE="chatMessage",gordon.User=a}(),this.gordon=this.gordon||{},function(){"use strict";function a(){this.values={},this.__updatedKeys=[],this.updatedKeys=[],this.initialized=!1,this.updatePolicy=0,this.id=-1,this._dataView=new DataView(new ArrayBuffer(1)),this.superconstructor()}var b=a.prototype=new gordon.Event;b.setString=function(a,b,c){if(null==a)throw new Error("Key is missing.");if(null==b)throw new Error("Value is missing.");c=c||!1;var d=new ArrayBuffer(b.length);return this.values[a]=gordon.Util.utf8StringToBuffer(b,d,0),this._checkSend(a,c),this},b.getString=function(a){return gordon.Util.bufferToUtf8String(this.values[a])},b.setObject=function(a,b,c){if(null==a)throw new Error("Key is missing.");if(null==b)throw new Error("Value is missing.");c=c||!1;var d=JSON.stringify(b),e=new ArrayBuffer(d.length);return this.values[a]=gordon.Util.utf8StringToBuffer(d,e,0),this._checkSend(a,c),this},b.getObject=function(a){var b=gordon.Util.bufferToUtf8String(this.values[a]);return JSON.parse(b)},b.setInt8=function(a,b,c){if(null==a)throw new Error("Key is missing.");if(null==b)throw new Error("Value is missing.");c=c||!1;var d=this.values[a];d||(d=this.values[a]=new ArrayBuffer(1)),new DataView(d).setInt8(0,b),this._checkSend(a,c)},b.getInt8=function(a){return new DataView(this.values[a]).getInt8(0)},b.setUint8=function(a,b,c){if(null==a)throw new Error("Key is missing.");if(null==b)throw new Error("Value is missing.");c=c||!1;var d=this.values[a];return d||(d=this.values[a]=new ArrayBuffer(1)),new DataView(d).setUint8(0,b),this._checkSend(a,c),this},b.getUint8=function(a){return new DataView(this.values[a]).getUint8(0)},b.setInt16=function(a,b,c){if(null==a)throw new Error("Key is missing.");if(null==b)throw new Error("Value is missing.");c=c||!1;var d=this.values[a];return d||(d=this.values[a]=new ArrayBuffer(2)),new DataView(d).setInt16(0,b),this._checkSend(a,c),this},b.getInt16=function(a){return new DataView(this.values[a]).getInt16(0)},b.setUint16=function(a,b,c){if(null==a)throw new Error("Key is missing.");if(null==b)throw new Error("Value is missing.");c=c||!1;var d=this.values[a];return d||(d=this.values[a]=new ArrayBuffer(2)),new DataView(d).setUint16(0,b),this._checkSend(a,c),this},b.getUint16=function(a){return new DataView(this.values[a]).getUint16(0)},b.setInt32=function(a,b,c){if(null==a)throw new Error("Key is missing.");if(null==b)throw new Error("Value is missing.");c=c||!1;var d=this.values[a];return d||(d=this.values[a]=new ArrayBuffer(4)),new DataView(d).setInt32(0,b),this._checkSend(a,c),this},b.getInt32=function(a){return new DataView(this.values[a]).getInt32(0)},b.setUint32=function(a,b,c){if(null==a)throw new Error("Key is missing.");if(null==b)throw new Error("Value is missing.");c=c||!1;var d=this.values[a];d||(d=this.values[a]=new ArrayBuffer(4)),new DataView(d).setUint32(0,b),this._checkSend(a,c)},b.getUint32=function(a){return new DataView(this.values[a]).getUint32(0)},b.setFloat32=function(a,b,c){if(null==a)throw new Error("Key is missing.");if(null==b)throw new Error("Value is missing.");c=c||!1;var d=this.values[a];d||(d=this.values[a]=new ArrayBuffer(4)),new DataView(d).setFloat32(0,b),this._checkSend(a,c)},b.getFloat32=function(a){return new DataView(this.values[a]).getFloat32(0)},b.setFloat64=function(a,b,c){if(null==a)throw new Error("Key is missing.");if(null==b)throw new Error("Value is missing.");c=c||!1;var d=this.values[a];d||(d=this.values[a]=new ArrayBuffer(8)),new DataView(d).setFloat64(0,b),this._checkSend(a,c)},b.getFloat64=function(a){return new DataView(this.values[a]).getFloat64(0)},b.getBufferSize=function(a){var b=2;if(a&&0!==a.length)for(c in a)b+=2,b+=4,b+=this.values[a[c]].byteLength;else for(var c in this.values)b+=2,b+=4,b+=this.values[c].byteLength;return b},b.sendUpdates=function(a){return a=a||!0,this.initialized&&0!==this.__updatedKeys.length?(this.__main._protocol.out_dataObjectUpdate(this,a),this.__updatedKeys.length=0,this):void 0},b.clearUpdatedKeys=function(){return this.__updatedKeys.length=0,this},b.dispose=function(){for(var a in this.values)this.values[a]=null,delete this.values[a];this.values=null,this.__main=null,this.__updatedKeys=null},b._checkSend=function(a,b){-1==this.__updatedKeys.indexOf(a)&&this.__updatedKeys.push(a),b&&this.sendUpdates()},a.DISPOSE="dispose",a.INITIALIZED="init",a.UPDATE="update",gordon.DataObject=a}(),this.gordon=this.gordon||{},function(){"use strict";var a=function(a){this.rooms=new gordon.Dictionary,this._dataObjects=new gordon.Dictionary,this._callbackPool=new gordon.Dictionary,this._callbackId=0,this._main=a},b=a.prototype;b.dispose=function(){this.rooms.dispose(),this._dataObjects.dispose(!0),this._callbackPool.dispose(),this.rooms=null,this._dataObjects=null,this._callbackPool=null,this._main=null},b.addDataObject=function(a){this._dataObjects.put(a.id,a)},b.getDataObject=function(a){return this._dataObjects.get(a)},b.removeDataObject=function(a){return this._dataObjects.remove(a)},b.addRoom=function(a){var b=new gordon.Room;return b.id=a,b._main=this._main,this.rooms.put(a,b),b},b.removeRoom=function(a){var b=this.rooms.remove(a);return b.__dispose(),b},b.getRoom=function(a,b){var c=this.rooms.get(a);return c||b&&(c=this.addRoom(a)),c},b.initDataObject=function(a,b){var c=this._callbackId++;return this._callbackId>65535&&(this._callbackId=1),this._callbackPool.put(c,[a,b]),c},b.putCallbackObject=function(a){var b=this._callbackId++;return this._callbackId>65535&&(this._callbackId=1),this._callbackPool.put(b,a),b},b.getCallbackObject=function(a){return this._callbackPool.remove(a)},gordon.Structure=a}(),this.gordon=this.gordon||{},function(){"use strict";var a=function(a){a=a||{},null==a.log&&(a.log=!0),a.pingInterval=a.pingInterval||1e4,a.messageBufferSize=a.messageBufferSize||1024,this._config=a,this._protocol=new gordon.Protocol(this),this._connection=new gordon.Connection(this,this._protocol),this._structure=new gordon.Structure(this),this.setPingInterval(this._config.pingInterval),this.superconstructor()},b=a.prototype=new gordon.Event;b.connect=function(a,b){if(!a)throw"[gordon] Argument missing.";b&&this.once(gordon.Event.CONNECTED,b),this._connection.connect(a)},b.join=function(a,b,c,d,e){if(!a||!b||!c)throw"[gordon] Argument missing.";e&&this.once(gordon.Event.JOINED,e),this._protocol.out_join(a,b,c,d)},b.changeRoom=function(a,b,c){if(!a)throw"[gordon] Argument missing.";c&&this.once(gordon.Event.ROOM_CHANGED,c),this._protocol.out_changeRoom(a,b)},b.setPingInterval=function(a){this.pingInterval=a,this._protocol.setPingInterval(a)},b.sendCustomMessage=function(a){this._protocol.out_customMessage(a)},b.sendChatMessage=function(a,b){b=b||0,this._protocol.out_chatMessage(b,a)},b.getCurrentPing=function(){return this._protocol.ping},b.getConnectionState=function(){return this._connection._webSocket.readyState},b.getSessionList=function(a){var b=this._structure.putCallbackObject(a);this._protocol.out_getSessionList(b)},b.getRoomList=function(a,b){var c=this._structure.putCallbackObject(b);this._protocol.out_getRoomList(a,c)},b.getUserList=function(a,b,c){var d=this._structure.putCallbackObject(c);this._protocol.out_getUserList(a,b,d)},b.dispose=function(){this._protocol.dispose(),this._structure.dispose(),this._connection.dispose(),this.me=null,this.currentRoom=null,this.superconstructor.dispose()},b._log=function(){this._config.log&&console.log(arguments)},gordon.Client=a}(),this.gordon=this.gordon||{},function(){"use strict";var a=function(a,b){this._client=a,this._protocol=b,this.url=""},b=a.prototype;b.connect=function(a){var b=this;this.url=a,this._webSocket=new WebSocket(this.url,["gordon-protocol"]),this._webSocket.binaryType="arraybuffer",this._webSocket.onopen=function(){b._client._log("[gordon] connected"),b._client.emit(gordon.Event.CONNECTED,0)},this._webSocket.onclose=function(){b._client._log("[gordon] closed"),b._client.emit(gordon.Event.CLOSED)},this._webSocket.onerror=function(a){b._client._log("[gordon] error",a),b._client.emit(gordon.Event.CONNECTED,1)},this._webSocket.onmessage=function(a){b._protocol.parse(a.data)}},b.send=function(a,b){if(1==this._webSocket.readyState){var c=new ArrayBuffer(b+4),d=new DataView(c);d.setUint32(0,b),gordon.Util.copyBytes(c,a.buffer,4,0,b),this._webSocket.send(c)}},b.dispose=function(){this._webSocket.close(),this._webSocket=null,this._client=null},gordon.Connection=a}(),this.gordon=this.gordon||{},function(){"use strict";var a=function(a){this._main=a,this._arrayBuffer=new ArrayBuffer(a._config.messageBufferSize),this._pingSentTime=0,this.ping=-1,this._commandHandlers={},this._commandHandlers[gordon.message.JOIN]=this._in_join,this._commandHandlers[gordon.message.JOIN_ERROR]=this._in_joinError,this._commandHandlers[gordon.message.CHANGE_ROOM]=this._in_changeRoom,this._commandHandlers[gordon.message.CHANGE_ROOM_ERROR]=this._in_changeRoomError,this._commandHandlers[gordon.message.NEW_USER]=this._in_newUser,this._commandHandlers[gordon.message.MASTER]=this._in_master,this._commandHandlers[gordon.message.USER_LEFT]=this._in_userLeft,this._commandHandlers[gordon.message.CUSTOM_MESSAGE]=this._in_customMessage,this._commandHandlers[gordon.message.CHAT_MESSAGE]=this._in_chatMessage,this._commandHandlers[gordon.message.PING]=this._in_ping,this._commandHandlers[gordon.message.DATA_OBJECT_CREATED]=this._in_dataObjectCreated,this._commandHandlers[gordon.message.DATA_OBJECT_DELETE]=this._in_dataObjectDeleted,this._commandHandlers[gordon.message.DATA_OBJECT_UPDATE]=this._in_dataObjectUpdate,this._commandHandlers[gordon.message.GET_SESSION_LIST]=this._in_getAList,this._commandHandlers[gordon.message.GET_ROOM_LIST]=this._in_getAList,this._commandHandlers[gordon.message.GET_USER_LIST]=this._in_getAList},b=a.prototype;b.dispose=function(){this._main=null,clearInterval(this._pingInv)},b.setPingInterval=function(a){var b=this;this.pingInterval=a,clearInterval(this._pingInv),this._pingInv=setInterval(function(){b.out_ping(),b._pingSentTime=Date.now()},a)},b.clearPingInterval=function(){clearInterval(this._pingInv)},b.parse=function(a){var b=new DataView(a),c=(b.getUint32(0),b.getUint8(4));this._commandHandlers[c]&&this._commandHandlers[c].apply(this,[b,5])},b._in_join=function(a,b){var c=a.buffer,d=a.getUint16(b);b+=2;var e=a.getUint16(b);b+=2;gordon.Util.bufferToUtf8String(c,b,e);b+=e;var f=a.getUint16(b);b+=2;var g=gordon.Util.bufferToUtf8String(c,b,f);b+=f;var h=a.getUint16(b);b+=2;var i=gordon.Util.bufferToUtf8String(c,b,h);b+=h,this.__dataObject.id=a.getUint16(b),b+=2;var j=a.getUint16(b);b+=2;var k=gordon.Util.bufferToUtf8String(c,b,j);b+=j;for(var l=this.__dataObject.values,m=c.byteLength;m>b;){var n=a.getUint16(b);b+=2;var o=a.getUint32(b);b+=4;var p=new ArrayBuffer(o);gordon.Util.copyBytes(p,c,0,b,o),b+=o,l[n]=p}var q=new gordon.User;q.id=d,q.name=k,q.dataObject=this.__dataObject,q.dataObject.__main=this._main,q.dataObject.initialized=!0;var r=this._main._structure.getRoom(g,!0);r.data=JSON.parse(i),r.__addUser(q),q.room=r,this._main.currentRoom=r,this._main.me=q,this._main._structure.addDataObject(this.__dataObject),this._main.emit(gordon.Event.JOINED,null,q),this.__dataObject=null,this.__roomId=-1,this.__sessionId=-1},b._in_joinError=function(a,b){var c={};c.id=a.getUint8(b),c.roomId=this.__roomId,c.sessionId=this.__sessionId,this._main.emit(gordon.Event.JOINED,c),this.__dataObject=null,this.__roomId=-1,this.__sessionId=-1},b._in_master=function(){this._main.me.master=!0,this._main.emit(gordon.Event.JOINED,error)},b._in_userLeft=function(a,b){var c=a.buffer,d=a.getUint16(b);b+=2;var e=a.getUint16(b);b+=2;gordon.Util.bufferToUtf8String(c,b,e);b+=e;var f=a.getUint16(b);b+=2;var g=gordon.Util.bufferToUtf8String(c,b,f);b+=f;var h=this._main._structure.getRoom(g),i=h.__removeUser(d);i.emit(gordon.User.DISPOSE,i),this._main.emit(gordon.Event.USER_LEFT,i),i.dispose()},b._in_newUser=function(a,b){var c=a.buffer,d=a.getUint16(b);b+=2;var e=a.getUint16(b);b+=2;var f=gordon.Util.bufferToUtf8String(c,b,e);b+=e;var g=a.getUint16(b);b+=2;gordon.Util.bufferToUtf8String(c,b,g);b+=g;var h=a.getUint8(b);b++;var i=gordon.Util.bufferToUtf8String(c,b,h);b+=h;var j=new gordon.User;j.name=i,j.id=d;var k=this._main._structure.getRoom(f,!0);k.__addUser(j),j.room=k;var l=a.getUint16(b);b+=2;var m=new gordon.DataObject;m.id=l,m.__main=this._main,this._main._structure.addDataObject(m),j.dataObject=m;for(var n=m.values,o=c.byteLength;o>b;){var p=a.getUint16(b);b+=2;var q=a.getUint32(b);b+=4;var r=new ArrayBuffer(q);gordon.Util.copyBytes(r,c,0,b,q),b+=q,n[p]=r}this._main.emit(gordon.Event.NEW_USER,j)},b._in_changeRoom=function(a,b){var c=this._main.me,d=gordon.Util.bufferToUtf8String(a.buffer,b);this._main._structure.removeRoom(c.room.id);var e=this._main._structure.getRoom(d,!0);e.__addUser(c),c.room=e,this._main.me.master=!1,this._main.currentRoom=e,this._main.emit(gordon.Event.ROOM_CHANGED,null,e)},b._in_customMessage=function(a,b){var c=new DataView(a.buffer.slice(b));this._main.emit(gordon.Event.CUSTOM_MESSAGE,c)},b._in_changeRoomError=function(a,b){var c=a.getUint8(b);this._main.emit(gordon.Event.ROOM_CHANGED,c)},b._in_chatMessage=function(a,b){var c=a.getUint16(b);b+=2;var d=a.getUint16(b);b+=2;var e=this._main.currentRoom.getUser(d);if(e){var f=gordon.Util.bufferToUtf8String(a.buffer,b);if(0===c)this._main.emit(gordon.Event.CHAT_MESSAGE,e,f);else{var g=this._main.currentRoom.getUser(c);if(!g)return;this._main.emit(gordon.Event.PRIVATE_CHAT_MESSAGE,e,g,f),g.emit(gordon.User.CHAT_MESSAGE,e,f)}}},b._in_dataObjectUpdate=function(a,b){var c=a.buffer,d=a.getUint8(b);b++;var e=a.getUint16(b);b+=2;var f=this._main._structure.getDataObject(e),g=!1;if(f||(f=new gordon.DataObject,f.id=e,f.__main=this._main,f.initialized=!0,f.updatePolicy=d,g=!0,this._main._structure.addDataObject(f)),-1!=f.id){for(var h=[],i=f.values,j=c.byteLength;j>b;){var k=a.getUint16(b);b+=2;var l=a.getUint32(b);b+=4;var m=new ArrayBuffer(l);gordon.Util.copyBytes(m,c,0,b,l),b+=l,i[k]=m,h.push(k)}f.updatedKeys=h,g?this._main.emit(gordon.Event.NEW_DATA_OBJECT,f):(f.emit(gordon.DataObject.UPDATE,h),this._main.emit(gordon.Event.DATA_OBJECT_UPDATE,f))}},b._in_dataObjectCreated=function(a,b){var c=(a.buffer,a.getUint16(b));b+=2;var d=a.getUint16(b);b+=2;var e=this._main._structure.getCallbackObject(c),f=e[0];f.__main=this._main,f.id=d,f.initialized=!0,this._main._structure.addDataObject(f),f.emit(gordon.DataObject.INITIALIZED),e[1]&&e[1].apply(null,[f])},b._in_dataObjectDeleted=function(a,b){var c=a.getUint16(b),d=this._main._structure.removeDataObject(c);this._main.emit(gordon.Event.DATA_OBJECT_REMOVED,d),d.emit(gordon.DataObject.DISPOSE),d.dispose()},b._in_ping=function(){this.ping=Date.now()-this._pingSentTime,this._main.emit(gordon.Event.PING,this.ping)},b._in_getAList=function(a,b){var c=a.buffer,d=a.getUint16(b);b+=2;var e=gordon.Util.bufferToUtf8String(c,b),f=this._main._structure.getCallbackObject(d);f.apply(f,[JSON.parse(e)])},b.out_join=function(a,b,c,d){d=d||new gordon.DataObject,this.__roomId=b,this.__sessionId=a,this.__dataObject=d,c=gordon.Util.toUtf8Buffer(c);var e=c.length;b=gordon.Util.toUtf8Buffer(b);var f=b.length,g=d.getBufferSize();a=gordon.Util.toUtf8Buffer(a);var h=a.length,i=new DataView(this._arrayBuffer,0,6+e+h+f+g),j=0;i.setInt8(j,gordon.message.JOIN),j++,i.setUint16(j,h),j+=2,gordon.Util.writeArrayToBuffer(i,j,a),j+=h,i.setUint16(j,f),j+=2,gordon.Util.writeArrayToBuffer(i,j,b),j+=f,i.setUint8(j,e),j+=1,gordon.Util.writeArrayToBuffer(i,j,c),j+=e,this._encodeDataObject(i,j,d,null),this._main._connection.send(i,j+g)},b.out_changeRoom=function(a,b){if(!a)throw"[Gordon] newRoomId not defined";b=b||"";var c=this._main.me.dataObject,d=c.getBufferSize(),e=gordon.Util.toUtf8Buffer(a),f=e.length,g=gordon.Util.toUtf8Buffer(b),h=g.length,i=0,j=new DataView(this._arrayBuffer,0,5+h+f+d);j.setUint8(i,gordon.message.CHANGE_ROOM),i++,j.setUint16(i,f),i+=2,gordon.Util.writeArrayToBuffer(j,i,e),i+=f,gordon.Util.writeArrayToBuffer(j,i,g),i+=h,this._encodeDataObject(j,i,c,null),this._main._connection.send(j,i+d)},b.out_customMessage=function(a){var b=new DataView(this._arrayBuffer,0,1+a.byteLength);b.setUint8(0,gordon.message.CUSTOM_MESSAGE),gordon.Util.copyBytes(b.buffer,a,1,0),this._main._connection.send(b,1+a.byteLength)},b.out_chatMessage=function(a,b){b=gordon.Util.toUtf8Buffer(b);var c=b.length,d=new DataView(this._arrayBuffer,0,3+c),e=0;d.setUint8(e,gordon.message.CHAT_MESSAGE),e++,d.setUint16(e,a),e+=2,gordon.Util.writeArrayToBuffer(d,e,b),this._main._connection.send(d,e+c)},b.out_ping=function(){var a=new DataView(this._arrayBuffer,0,1);a.setInt8(0,gordon.message.PING),this._pingSendTime=Date.now(),this._main._connection.send(a,1)},b.out_getSessionList=function(a){var b=new DataView(this._arrayBuffer,0,3),c=0;b.setInt8(0,gordon.message.GET_SESSION_LIST),c++,b.setUint16(c,a),c+=2,this._main._connection.send(b,c)},b.out_getRoomList=function(a,b){a=gordon.Util.toUtf8Buffer(a);var c=a.length,d=new DataView(this._arrayBuffer,0,5+c),e=0;d.setInt8(0,gordon.message.GET_ROOM_LIST),e++,d.setUint16(e,b),e+=2,d.setUint16(e,c),e+=2,gordon.Util.writeArrayToBuffer(d,e,a),this._main._connection.send(d,e+c)},b.out_getUserList=function(a,b,c){a=gordon.Util.toUtf8Buffer(a);var d=a.length;b=gordon.Util.toUtf8Buffer(b);var e=b.length,f=new DataView(this._arrayBuffer,0,5+d+2+e),g=0;f.setInt8(0,gordon.message.GET_USER_LIST),g++,f.setUint16(g,c),g+=2,f.setUint16(g,d),g+=2,gordon.Util.writeArrayToBuffer(f,g,a),g+=d,f.setUint16(g,e),g+=2,gordon.Util.writeArrayToBuffer(f,g,b),g+=e,this._main._connection.send(f,g)},b.out_initDataObject=function(a,b,c){var d=a.getBufferSize(),e=0,f=new DataView(this._arrayBuffer,0,4+d);f.setUint8(e,gordon.message.INIT_DATA_OBJECT),e++,f.setUint8(e,b),e++,f.setUint16(e,c),e+=2,this._encodeDataObject(f,e,a,null),this._main._connection.send(f,e+d)},b.out_dataObjectUpdate=function(a,b){if(0!==a.__updatedKeys.length){var c=0,d=a.getBufferSize(a.__updatedKeys),e=new DataView(this._arrayBuffer,0,2+d);e.setUint8(c,gordon.message.DATA_OBJECT_UPDATE),c++,e.setUint8(c,Number(b)),c++,this._encodeDataObject(e,c,a,a.__updatedKeys),this._main._connection.send(e,c+d),a.__updatedKeys.length=0}},b.out_deleteDataObject=function(a){var b=0,c=new DataView(this._arrayBuffer,0,3);c.setUint8(b,gordon.message.DATA_OBJECT_DELETE),b++,c.setUint16(b,a.id),b+=2,this._main._connection.send(c,b)},b._encodeDataObject=function(a,b,c,d){a.setUint16(b,c.id),b+=2;var e=c.values;for(var f in e)if(!d||-1!=d.indexOf(Number(f))){a.setUint16(b,Number(f)),b+=2;var g=e[f],h=g.byteLength;a.setUint32(b,h),b+=4,gordon.Util.copyBytes(a.buffer,g,b),b+=h}},gordon.Protocol=a}();